<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elegant Watch Receipt Generator</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0d0d10">
    <script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js')
            .then(reg => console.log('Service Worker registered:', reg))
            .catch(err => console.error('SW registration failed:', err));
        });
    }
    </script>

    <style>
        /* ================================================================= */
        /* === CRITICAL UTILITY CLASSES (REQUIRED FOR JS FUNCTIONALITY) === */
        /* ================================================================= */
        .hidden {
            display: none !important;
        }
        .flex {
            display: flex !important;
        }
        .items-center {
            align-items: center !important;
        }
        .justify-center {
            justify-content: center !important;
        }
        /* ================================================================= */
        /* === END CRITICAL UTILITY CLASSES === */
        /* ================================================================= */

        /* Custom scrollbar for a sleek look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background: #374151; /* Gray-700 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-track {
            background: #111827; /* Gray-900 */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d0d10; /* Very dark background */
            min-height: 100vh; /* min-h-screen */
            padding: 1rem; /* p-4 */
            display: flex; /* flex */
            flex-direction: column; /* flex-col */
            align-items: center; /* items-center */
            justify-content: center; /* justify-center */
        }

        @media (min-width: 640px) {
            body {
                padding: 2rem; /* sm:p-8 */
            }
        }

        /* HEADER AND CONTROLS */
        #controls {
            width: 100%; /* w-full */
            max-width: 56rem; /* max-w-4xl */
            text-align: center; /* text-center */
            margin-bottom: 2rem; /* mb-8 */
        }

        .header-title {
            font-size: 2.25rem; /* text-4xl */
            font-weight: 800; /* font-extrabold */
            color: #ffffff; /* text-white */
            margin-bottom: 0.5rem; /* mb-2 */
        }

        @media (min-width: 640px) {
            .header-title {
                font-size: 3rem; /* sm:text-5xl */
            }
        }

        .header-subtitle {
            color: #9ca3af; /* text-gray-400 */
            font-size: 1.125rem; /* text-lg */
            margin-bottom: 1.5rem; /* mb-6 */
        }
        
        .control-group {
            display: flex; /* flex */
            flex-wrap: wrap; /* flex-wrap */
            justify-content: center; /* justify-center */
            /* Adjusted gap for tighter mobile fit */
            gap: 0.75rem; /* Was gap-4 (1rem) */
        }

        /* PRIMARY BUTTONS (Controls) */
        .btn-base {
            font-weight: 600; /* font-semibold */
            /* Adjusted padding for better mobile tapping */
            padding: 0.75rem 1.25rem; /* Was py-3 px-6 */
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-lg */
            transition: all 0.2s ease-in-out; /* transition duration-200 */
            transform: scale(1); /* initial state */
            color: #ffffff;
            cursor: pointer;
            border: none;
            /* Allow buttons to wrap more cleanly */
            flex-grow: 1; 
            max-width: 100%; /* Default to full width on smallest screens before wrap */
        }
        @media (min-width: 500px) { /* Adjust breakpoint for button layout */
             .btn-base {
                 flex-grow: 0;
                 max-width: none;
             }
        }
        .btn-base:hover {
            transform: scale(1.05); /* hover:scale-105 */
        }
        .btn-icon {
            height: 1.25rem; /* h-5 */
            width: 1.25rem; /* w-5 */
            display: inline;
            margin-right: 0.5rem; /* mr-2 */
        }

        .btn-indigo {
            background-color: #4f46e5; /* bg-indigo-600 */
        }
        .btn-indigo:hover {
            background-color: #4338ca; /* hover:bg-indigo-700 */
        }

        .btn-green {
            background-color: #10b981; /* bg-green-600 */
        }
        .btn-green:hover {
            background-color: #059669; /* hover:bg-green-700 */
        }

        .btn-purple {
            background-color: #9333ea; /* bg-purple-600 */
        }
        .btn-purple:hover {
            background-color: #7e22ce; /* hover:bg-purple-700 */
        }

        /* MODAL BUTTONS */
        .btn-modal-base {
            font-weight: 600; /* font-semibold */
            padding: 0.5rem 1rem; /* py-2 px-4 */
            border-radius: 0.5rem; /* rounded-lg */
            color: #ffffff;
            transition: background-color 0.15s ease-in-out;
            cursor: pointer;
            border: none;
        }
        .btn-modal-cancel {
            background-color: #4b5563; /* bg-gray-600 */
        }
        .btn-modal-cancel:hover {
            background-color: #374151; /* hover:bg-gray-700 */
        }
        .btn-modal-indigo-save {
            background-color: #4f46e5; /* bg-indigo-600 */
        }
        .btn-modal-indigo-save:hover {
            background-color: #4338ca; /* hover:bg-indigo-700 */
        }
        .btn-modal-green-save {
            background-color: #10b981; /* bg-green-600 */
        }
        .btn-modal-green-save:hover {
            background-color: #059669; /* hover:bg-green-700 */
        }
        .btn-red-modal {
            background-color: #dc2626; /* bg-red-600 */
            color: #ffffff;
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: background-color 0.15s ease-in-out;
            cursor: pointer;
            border: none;
        }
        .btn-red-modal:hover {
            background-color: #b91c1c; /* hover:bg-red-700 */
        }


        /* RECEIPT CONTAINER */
        #receiptWrapper {
            width: 100%; /* w-full */
            max-width: 22rem; /* Adjusted for mobile: was max-w-sm (24rem) */
            /* Drastically reduced base padding for better mobile fit and clean PDF */
            padding: 1.5rem; /* Was p-12 (3rem) */
            background-color: #ffffff; /* bg-white */
            border-radius: 1rem; /* rounded-2xl */
            border: 1px solid #e5e7eb; /* border border-gray-200 */
        }

        @media (min-width: 640px) {
            #receiptWrapper {
                max-width: 30rem; /* Adjusted for sm: was max-w-lg (36rem) */
                padding: 2.5rem; /* Increased padding for larger screens */
            }
        }
        @media (min-width: 1024px) {
            #receiptWrapper {
                max-width: 36rem; /* Adjusted for lg: was max-w-xl (42rem) */
                padding: 3.5rem; /* Further increased padding for desktop view */
            }
        }
        
        .receipt-container {
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            transition: all 0.3s ease-in-out;
        }
        .receipt-container:hover {
             box-shadow: 0 35px 60px -15px rgba(0, 0, 0, 0.7);
        }
        
        #receiptContent {
            color: #1f2937; /* Dark text for high contrast on white (text-gray-800) */
        }

        /* RECEIPT CONTENT STYLES */
        .receipt-header-top {
            text-align: center; /* text-center */
            padding-bottom: 1.5rem; /* Was pb-8 (2rem) */
            margin-bottom: 1rem; /* Was mb-6 (1.5rem) */
            border-bottom: 2px solid #e0e7ff; /* border-b-2 border-indigo-100 */
        }
        .receipt-header-top > div:first-child {
            margin-bottom: 0.75rem; /* mb-3 */
        }

        .company-logo {
            height: 3rem; /* h-12 */
            object-fit: contain; /* object-contain */
            margin: 0 auto; /* mx-auto */
            max-width: 180px; 
            height: 48px;
        }

        .company-name {
            font-size: 1.5rem; /* Reduced for mobile: was text-3xl (1.875rem) */
            font-weight: 800; /* font-extrabold */
            color: #111827; /* text-gray-900 */
        }
        @media (min-width: 640px) {
            .company-name {
                 font-size: 1.875rem; /* Restore original size on larger screens */
            }
        }


        .tagline {
            color: #6b7280; /* text-gray-500 */
            font-size: 0.875rem; /* text-sm */
        }

        .receipt-meta {
            display: flex; /* flex */
            justify-content: space-between; /* justify-between */
            font-size: 0.75rem; /* Reduced for mobile: was text-sm (0.875rem) */
            color: #4b5563; /* text-gray-600 */
            margin-bottom: 1.5rem; /* mb-6 */
            padding-left: 0.25rem; /* px-1 */
            padding-right: 0.25rem; /* px-1 */
        }
        @media (min-width: 640px) {
            .receipt-meta {
                font-size: 0.875rem; /* Restore original size on larger screens */
            }
        }
        .text-right {
            text-align: right;
        }
        .font-semibold {
            font-weight: 600;
        }
        .font-bold {
            font-weight: 700;
        }
        .text-gray-700 {
            color: #374151;
        }
        .text-gray-900 {
            color: #111827;
        }
        
        /* ITEM LIST */
        .item-row {
            display: flex; /* flex */
            justify-content: space-between; /* justify-between */
            align-items: center; /* items-center */
            /* Reduced vertical padding for better item density on mobile */
            padding-top: 0.75rem; /* Was py-4 (1rem) */
            padding-bottom: 0.75rem; /* Was py-4 (1rem) */
            border-bottom: 1px solid #e5e7eb; /* border-b border-gray-200 */
            transition: background-color 0.15s; /* transition duration-150 */
            padding-left: 0.25rem; /* px-1 */
            padding-right: 0.25rem; /* px-1 */
            cursor: pointer;
        }
        .item-row:hover {
            background-color: #eef2ff; /* hover:bg-indigo-50 */
        }

        .item-details-group {
            flex: 1; /* flex-1 */
            display: flex; /* flex */
            align-items: center; /* items-center */
        }

        .item-image {
            height: 2.5rem; /* Reduced image size for mobile: was h-12 (3rem) */
            width: 2.5rem; /* Reduced image size for mobile: was w-12 (3rem) */
            object-fit: cover; /* object-cover */
            border-radius: 0.375rem; /* rounded-md */
            margin-right: 0.75rem; /* Reduced margin: was mr-4 (1rem) */
            border: 1px solid #e5e7eb; /* border border-gray-200 */
            min-width: 40px; /* Adjusted min-width */
        }
        @media (min-width: 640px) {
            .item-image {
                 height: 3rem; 
                 width: 3rem; 
                 margin-right: 1rem;
            }
        }


        .item-name {
            font-size: 1rem; /* Reduced for mobile: was text-lg (1.125rem) */
            font-weight: 500; /* font-medium */
            color: #111827; /* text-gray-900 */
        }
        @media (min-width: 640px) {
            .item-name {
                 font-size: 1.125rem; 
            }
        }
        .item-subtext {
            font-size: 0.75rem; /* text-xs */
            color: #6b7280; /* text-gray-500 */
            font-style: italic; /* italic */
        }
        .item-price {
            font-size: 1rem; /* Reduced for mobile: was text-lg (1.125rem) */
            font-weight: 600; /* font-semibold */
            color: #1f2937; /* text-gray-800 */
        }
        @media (min-width: 640px) {
            .item-price {
                 font-size: 1.125rem; 
            }
        }
        
        /* TOTALS AND FOOTER */
        .totals-group {
            margin-top: 1.5rem; /* Reduced margin: was mt-8 (2rem) */
            padding-top: 1rem; /* Reduced padding: was pt-6 (1.5rem) */
            text-align: right; /* text-right */
        }
        .totals-group > div {
            margin-bottom: 0.5rem; /* Reduced margin: was mb-3 (0.75rem) */
        }
        .totals-group > div:last-child {
            margin-bottom: 0;
        }
        
        .total-line {
            display: flex; /* flex */
            justify-content: space-between; /* justify-between */
            font-size: 0.875rem; /* Reduced for mobile: was text-md (1rem) */
            color: #4b5563; /* text-gray-600 */
        }
        @media (min-width: 640px) {
            .total-line {
                 font-size: 1rem; 
            }
        }

        .final-total-line {
            display: flex; /* flex */
            justify-content: space-between; /* justify-between */
            font-size: 1.5rem; /* Reduced for mobile: was text-3xl (1.875rem) */
            font-weight: 800; /* font-extrabold */
            color: #4f46e5; /* text-indigo-700 */
            padding-top: 1rem; /* Reduced padding: was pt-5 (1.25rem) */
            border-top: 1px solid #c7d2fe; /* border-t border-indigo-200 */
        }
        @media (min-width: 640px) {
            .final-total-line {
                 font-size: 1.875rem; 
            }
        }
        .final-total-line > span:first-child {
            letter-spacing: 0.05em; /* tracking-wider */
        }
        .final-total-line > span:last-child {
            font-weight: 900; /* font-black */
        }

        .receipt-footer {
            text-align: center; /* text-center */
            margin-top: 2rem; /* Reduced margin: was mt-10 (2.5rem) */
            padding-top: 0.75rem; /* Reduced padding: was pt-4 (1rem) */
            border-top: 1px solid #9ca3af; /* border-t border-gray-300 */
        }
        .receipt-footer p:first-child {
            color: #4b5563; /* text-gray-600 */
            font-size: 0.875rem; /* text-sm */
            font-style: italic;
        }
        .receipt-footer p:last-child {
            color: #6b7280; /* text-gray-500 */
            font-size: 0.75rem; /* text-xs */
            margin-top: 0.25rem; /* mt-1 */
        }

        /* MODAL STYLES */
        .fixed-modal {
            position: fixed; /* fixed */
            inset: 0; /* inset-0 */
            background-color: rgba(17, 24, 39, 0.75); /* bg-gray-900 bg-opacity-75 */
            z-index: 50; /* z-50 */
            /* Add overflow scroll to ensure modals are usable on very small screens */
            overflow-y: auto;
        }
        .modal-content {
            background-color: #1f2937; /* bg-gray-800 */
            padding: 1.5rem; /* p-6 */
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); /* shadow-2xl */
            width: 100%; /* w-full */
            max-width: 26rem; /* Reduced for mobile: was max-w-md (28rem) */
            margin: 0.75rem; /* Reduced margin: was m-4 (1rem) */
            opacity: 1;
        }
        @media (min-width: 640px) {
            .modal-content {
                padding: 2rem; /* sm:p-8 */
                max-width: 28rem;
                margin: 2rem;
            }
        }
        .modal-title {
            font-size: 1.5rem; /* Reduced for mobile: was text-3xl (1.875rem) */
            font-weight: 700; /* font-bold */
            color: #ffffff; /* text-white */
            margin-bottom: 1rem; /* Reduced margin: was mb-6 (1.5rem) */
            padding-bottom: 0.5rem; /* pb-2 */
        }
        .border-b-indigo {
            border-bottom: 2px solid #4f46e5; /* border-b border-indigo-700 */
        }
        .border-b-green {
            border-bottom: 2px solid #059669; /* border-b border-green-700 */
        }
        .form-label {
            display: block; /* block */
            color: #d1d5db; /* text-gray-300 */
            font-weight: 500; /* font-medium */
            margin-bottom: 0.25rem; /* mb-1 */
            font-size: 0.875rem; /* text-sm */
        }
        .form-group {
            margin-bottom: 0.75rem; /* Reduced margin: was mb-4 (1rem) */
        }
        .form-input {
            width: 100%; /* w-full */
            background-color: #374151; /* bg-gray-700 */
            color: #ffffff; /* text-white */
            border: 1px solid #4b5563; /* border border-gray-600 */
            border-radius: 0.5rem; /* rounded-lg */
            padding: 0.65rem; /* Reduced padding: was p-3 (0.75rem) */
            font-size: 1rem;
        }
        /* Simplified focus ring for cleaner mobile look */
        .focus-ring-indigo:focus,
        .focus-ring-green:focus {
            outline: none; /* Remove default outline */
            box-shadow: 0 0 0 2px #1f2937, 0 0 0 4px #4f46e5; /* Custom ring for indigo/green */
            border-color: #4f46e5;
        }
        .focus-ring-green:focus {
            box-shadow: 0 0 0 2px #1f2937, 0 0 0 4px #10b981;
            border-color: #10b981;
        }

        .file-input-text {
            color: #9ca3af; /* text-gray-400 */
            font-size: 0.75rem; /* text-xs */
            margin-top: 0.25rem; /* mt-1 */
        }
        .modal-footer {
            display: flex; /* flex */
            justify-content: flex-end; /* justify-end */
            gap: 0.5rem; /* Reduced gap: was space-x-3 (0.75rem) */
            margin-top: 1.25rem; /* Added margin to separate from inputs */
        }
        
        /* FILE INPUT CUSTOM STYLES */
        .form-input[type="file"]::file-selector-button {
            margin-right: 0.75rem; /* file:mr-4 (1rem) */
            padding: 0.4rem 0.8rem; /* file:py-2 file:px-4 */
            border-radius: 9999px; /* file:rounded-full */
            border: 0; /* file:border-0 */
            font-size: 0.875rem; /* file:text-sm */
            font-weight: 600; /* file:font-semibold */
            cursor: pointer;
            transition: background-color 0.15s;
        }
        #logoFile::file-selector-button {
            background-color: #eef2ff; /* file:bg-indigo-50 */
            color: #4338ca; /* file:text-indigo-700 */
        }
        #logoFile::file-selector-button:hover {
            background-color: #e0e7ff; /* hover:file:bg-indigo-100 */
        }
        #watchImage::file-selector-button {
            background-color: #ecfdf5; /* file:bg-green-50 */
            color: #047857; /* file:text-green-700 */
        }
        #watchImage::file-selector-button:hover {
            background-color: #d1fae5; /* hover:file:bg-green-100 */
        }
        
        /* Custom spinner animation (used in the download button) */
        @keyframes spin { 
            from { transform: rotate(0deg); } 
            to { transform: rotate(360deg); } 
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8 flex flex-col items-center justify-center">

    <div id="controls">
        <h1 class="header-title">Luxury Receipt Creator</h1>
        <p class="header-subtitle">Design and download your watch transaction record.</p>
        
        <div class="control-group">
            <button onclick="showModal('settingsModal')" id="settingsBtn" 
                class="btn-base btn-indigo">
                <svg xmlns="http://www.w3.org/2000/svg" class="btn-icon" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 002.583 1.342 1.532 1.532 0 00-2.583 1.342c.38 1.56 2.6 1.56 2.98 0a1.532 1.532 0 002.583 1.342 1.532 1.532 0 00-2.583 1.342z" clip-rule="evenodd" />
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-10a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V8z" clip-rule="evenodd" />
                </svg>
                Company Settings
            </button>
            <button onclick="showModal('itemModal')" id="addItemBtn" 
                class="btn-base btn-green">
                <svg xmlns="http://www.w3.org/2000/svg" class="btn-icon" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" />
                </svg>
                Add Watch
            </button>
            <button onclick="downloadReceipt()" id="downloadBtn" 
                class="btn-base btn-purple">
                <svg xmlns="http://www.w3.org/2000/svg" class="btn-icon" viewBox="0 0 20 20" fill="currentColor">
                  <path d="M13 14H7V6h6v8zm0-10H7v2h6V4zM16 10c0 3.31-2.69 6-6 6s-6-2.69-6-6h2c0 2.21 1.79 4 4 4s4-1.79 4-4H16z"/>
                </svg>
                Download Receipt (PDF)
            </button>
        </div>
    </div>

    <div id="receiptWrapper" class="receipt-container border border-gray-200">
        
        <div id="receiptContent">
            </div>
    </div>
    
    <div id="settingsModal" class="fixed-modal hidden items-center justify-center">
        <div class="modal-content">
            <h2 class="modal-title border-b-indigo">Company Details</h2>
            
            <form onsubmit="updateSettings(event)">
                <div class="form-group">
                    <label for="companyName" class="form-label">Company Name</label>
                    <input type="text" id="companyName" class="form-input focus-ring-indigo" placeholder="e.g., Luxury Timepieces Inc." required>
                </div>
                <div class="form-group">
                    <label for="logoFile" class="form-label">Company Logo (Image File)</label>
                    <input type="file" id="logoFile" accept="image/*" class="form-input focus-ring-indigo">
                    <p class="file-input-text">Leave blank to keep the existing logo or use text.</p>
                </div>
                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label for="transactionMethod" class="form-label">Payment Method</label>
                    <select id="transactionMethod" class="form-input focus-ring-indigo" required>
                        <option value="Wire Transfer">Wire Transfer</option>
                        <option value="Credit Card">Credit Card</option>
                        <option value="Cryptocurrency">Cryptocurrency</option>
                        <option value="Cash">Cash</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" onclick="hideModal('settingsModal')" class="btn-modal-base btn-modal-cancel">Cancel</button>
                    <button type="submit" class="btn-modal-base btn-modal-indigo-save">Save Settings</button>
                </div>
            </form>
        </div>
    </div>

    <div id="itemModal" class="fixed-modal hidden items-center justify-center">
        <div class="modal-content">
            <h2 class="modal-title border-b-green">Add New Watch</h2>
            
            <form onsubmit="addItem(event)">
                <input type="hidden" id="itemId" value="">
                <div class="form-group">
                    <label for="watchName" class="form-label">Watch Name / Model</label>
                    <input type="text" id="watchName" class="form-input focus-ring-green" placeholder="e.g., Rolex Daytona 116500LN" required>
                </div>
                <div class="form-group">
                    <label for="watchImage" class="form-label">Product Image (Optional)</label>
                    <input type="file" id="watchImage" accept="image/*" class="form-input focus-ring-green">
                    <p class="file-input-text" id="currentWatchImage"></p>
                </div>
                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label for="watchPrice" class="form-label">Price (USD)</label>
                    <input type="number" id="watchPrice" step="0.01" min="0.01" class="form-input focus-ring-green" placeholder="e.g., 25000.00" required>
                </div>
                <div class="modal-footer">
                    <button type="button" onclick="hideModal('itemModal')" class="btn-modal-base btn-modal-cancel">Cancel</button>
                    <button type="submit" id="itemSubmitBtn" class="btn-modal-base btn-modal-green-save">Add Watch</button>
                </div>
            </form>
        </div>
    </div>

<script>
    // --- Global State ---
    let receiptData = {
        company: {
            name: '', 
            logoUrl: '',
            transactionMethod: 'Wire Transfer',
            receiptId: Date.now().toString().slice(-6),
            date: new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })
        },
        items: [], 
        nextItemId: 1 
    };

    // --- Utility Functions (unchanged) ---

    function showModal(id) {
        document.getElementById(id).classList.remove('hidden');
        document.getElementById(id).classList.add('flex');
    }

    function hideModal(id) {
        document.getElementById(id).classList.add('hidden');
        document.getElementById(id).classList.remove('flex');
    }

    function formatCurrency(amount) {
        return new Intl.NumberFormat('en-US', { 
            style: 'currency', 
            currency: 'USD',
            minimumFractionDigits: 2 
        }).format(amount);
    }
    
    function calculateTotal() {
        return receiptData.items.reduce((sum, item) => sum + item.price, 0);
    }
    
    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
            reader.readAsDataURL(file);
        });
    }

    // --- Core Rendering Function (unchanged) ---
    
    function renderReceipt() {
        const contentDiv = document.getElementById('receiptContent');
        
        if (receiptData.items.length === 0 && !receiptData.company.name) {
             const placeholderHtml = `
                <div style="text-align: center; padding-top: 2.5rem; padding-bottom: 2.5rem; color: #9ca3af;">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="height: 2.5rem; width: 2.5rem; margin: 0 auto; margin-bottom: 0.75rem;">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                    </svg>
                    <p>Start by setting your Company Name and adding watches!</p>
                </div>
            `;
            contentDiv.innerHTML = placeholderHtml;
            // Restore default styles in case they were modified during a failed PDF attempt
            const receiptWrapper = document.getElementById('receiptWrapper');
            receiptWrapper.style.boxShadow = '0 25px 50px -12px rgba(0, 0, 0, 0.5)';
            receiptWrapper.style.border = '1px solid #e5e7eb';
            return;
        }

        const total = calculateTotal();
        const taxRate = 0.00; 
        const tax = total * taxRate;
        const finalTotal = total + tax;
        
        let logoHtml;
        if (receiptData.company.logoUrl) {
            logoHtml = `<img src="${receiptData.company.logoUrl}" alt="Company Logo" class="company-logo"/>`;
        } else if (receiptData.company.name) {
             logoHtml = `<div style="font-size: 3rem; font-weight: 800; color: #4f46e5;">${receiptData.company.name.charAt(0)}</div>`;
        } else {
             logoHtml = `<div style="font-size: 3rem; font-weight: 800; color: #6b7280;">--</div>`;
        }
            
        const headerHtml = `
            <div class="receipt-header-top">
                <div style="margin-bottom: 0.75rem;">${logoHtml}</div>
                <h2 class="company-name">${receiptData.company.name.toUpperCase() || 'LUXURY WATCHES RETAIL'}</h2>
                <p class="tagline">Thank you for your valued business.</p>
            </div>
            <div class="receipt-meta">
                <div>
                    <p class="font-semibold">RECEIPT ID: <span class="text-gray-900 font-bold">#${receiptData.company.receiptId}</span></p>
                    <p>DATE: <span class="text-gray-700">${receiptData.company.date}</span></p>
                </div>
                <div class="text-right">
                    <p>PAYMENT METHOD: <span class="text-gray-700">${receiptData.company.transactionMethod.toUpperCase()}</span></p>
                </div>
            </div>
        `;

        const itemsHtml = receiptData.items.map(item => `
            <div class="item-row" 
                 ondblclick="editItem(${item.id})">
                
                <div class="item-details-group">
                    ${item.imageUrl ? `<img src="${item.imageUrl}" alt="${item.name}" class="item-image"/>` : ''}
                    <div>
                        <p class="item-name">${item.name}</p>
                        <p class="item-subtext">Double click to edit/delete</p>
                    </div>
                </div>
                <p class="item-price">${formatCurrency(item.price)}</p>
            </div>
        `).join('');

        const noItemsPrompt = receiptData.items.length === 0 ? `
            <div style="text-align: center; padding-top: 2.5rem; padding-bottom: 2.5rem; color: #6b7280; border-bottom: 1px solid #e5e7eb;">
                <p style="font-weight: 500;">No items added yet. Click 'Add Watch' to list products.</p>
            </div>
        ` : '';

        const totalsHtml = `
            ${noItemsPrompt}
            <div class="totals-group">
                <div class="total-line">
                    <span class="font-medium">SUBTOTAL:</span>
                    <span>${formatCurrency(total)}</span>
                </div>
                <div class="total-line">
                    <span class="font-medium">TAX (0%):</span>
                    <span>${formatCurrency(tax)}</span>
                </div>
                <div class="final-total-line">
                    <span style="letter-spacing: 0.05em;">TOTAL AMOUNT:</span>
                    <span style="font-weight: 900;">${formatCurrency(finalTotal)}</span>
                </div>
            </div>
            <div class="receipt-footer">
                <p style="color: #4b5563; font-size: 0.875rem; font-style: italic;">This document confirms the transaction of luxury timepieces.</p>
                <p style="color: #6b7280; font-size: 0.75rem; margin-top: 0.25rem;">Receipt is automatically generated and digitally verifiable.</p>
            </div>
        `;

        contentDiv.innerHTML = headerHtml + itemsHtml + totalsHtml;
    }


    // --- CRUD Functions (unchanged) ---

    async function updateSettings(e) {
        e.preventDefault();
        
        const name = document.getElementById('companyName').value;
        const fileInput = document.getElementById('logoFile');
        const method = document.getElementById('transactionMethod').value;
        
        let logoDataUrl = receiptData.company.logoUrl; 

        if (fileInput.files.length > 0) {
            try {
                logoDataUrl = await fileToBase64(fileInput.files[0]);
                fileInput.value = '';
            } catch (error) {
                console.error("Error reading logo file:", error);
                alert('Could not read the logo file. Please try again or use a different file.');
                return;
            }
        }
        
        receiptData.company.name = name;
        receiptData.company.logoUrl = logoDataUrl;
        receiptData.company.transactionMethod = method;

        renderReceipt();
        hideModal('settingsModal');
    }

    async function addItem(e) {
        e.preventDefault();
        
        const id = document.getElementById('itemId').value;
        const name = document.getElementById('watchName').value;
        const price = parseFloat(document.getElementById('watchPrice').value);
        
        const imageInput = document.getElementById('watchImage');
        let imageUrl = '';
        
        if (imageInput.files.length > 0) {
            try {
                 imageUrl = await fileToBase64(imageInput.files[0]);
            } catch (error) {
                console.error("Error reading product image:", error);
                alert('Could not read the product image file. Please try again.');
                return;
            }
        } else if (id) {
            const existingItem = receiptData.items.find(i => i.id === parseInt(id));
            if (existingItem) {
                imageUrl = existingItem.imageUrl;
            }
        }

        if (id) {
            const itemIndex = receiptData.items.findIndex(i => i.id === parseInt(id));
            if (itemIndex > -1) {
                receiptData.items[itemIndex].name = name;
                receiptData.items[itemIndex].price = price;
                receiptData.items[itemIndex].imageUrl = imageUrl;
            }
        } else {
            receiptData.items.push({
                id: receiptData.nextItemId++,
                name: name,
                price: price,
                imageUrl: imageUrl
            });
        }
        
        document.getElementById('itemId').value = '';
        document.getElementById('watchName').value = '';
        document.getElementById('watchPrice').value = '';
        document.getElementById('watchImage').value = '';
        document.getElementById('itemSubmitBtn').innerText = 'Add Watch';
        
        const submitContainer = document.querySelector('#itemModal form .modal-footer');
        const deleteBtn = submitContainer.querySelector('.btn-red-modal');
        if (deleteBtn) deleteBtn.remove();
        document.getElementById('currentWatchImage').innerText = '';
        
        hideModal('itemModal');
        renderReceipt();
    }
    
    function editItem(id) {
        const item = receiptData.items.find(i => i.id === id);
        if (!item) return;

        document.getElementById('itemId').value = item.id;
        document.getElementById('watchName').value = item.name;
        document.getElementById('watchPrice').value = item.price;
        document.getElementById('itemSubmitBtn').innerText = 'Update Watch';

        const currentImageStatus = document.getElementById('currentWatchImage');
        if (item.imageUrl) {
            currentImageStatus.innerText = 'Image: Present (Select new file to change)';
            currentImageStatus.style.color = '#4ade80';
        } else {
            currentImageStatus.innerText = 'Image: None';
            currentImageStatus.style.color = '#9ca3af';
        }
        document.getElementById('watchImage').value = '';

        const deleteBtnHtml = `<button type="button" onclick="deleteItem(${id}); hideModal('itemModal');" class="btn-red-modal">Delete</button>`;
        const submitContainer = document.querySelector('#itemModal form .modal-footer');
        
        if (!submitContainer.querySelector('.btn-red-modal')) {
            submitContainer.insertAdjacentHTML('afterbegin', deleteBtnHtml);
        }

        showModal('itemModal');
    }

    function deleteItem(id) {
        receiptData.items = receiptData.items.filter(item => item.id !== id);
        renderReceipt();
    }

    // --- PDF Download Function (FIXED) ---

    function downloadReceipt() {
        const downloadBtn = document.getElementById('downloadBtn');
        const receiptElement = document.getElementById('receiptWrapper');
        const originalText = downloadBtn.innerHTML;

        if (!receiptElement || !window.jspdf) {
            alert("PDF libraries failed to load. Please check your network connection.");
            return;
        }
        
        // 1. Set loading state
        downloadBtn.innerHTML = '<svg fill="none" viewBox="0 0 24 24" style="animation: spin 1s linear infinite; height: 1.25rem; width: 1.25rem; display: inline; margin-left: -0.25rem; margin-right: 0.75rem; color: #ffffff;" xmlns="http://www.w3.org/2000/svg"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Generating PDF...';
        downloadBtn.disabled = true;

        // 2. Initialize jsPDF
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');

        // 3. Calculate scale factor to fit content within PDF margins (10mm on each side)
        const receiptWidth = receiptElement.offsetWidth;
        const pdfWidth = doc.internal.pageSize.getWidth();
        const margin = 10;
        const scaleFactor = (pdfWidth - 2 * margin) / receiptWidth; 
        
        // 4. Temporarily remove disruptive styles for a cleaner PDF capture
        const originalBoxShadow = receiptElement.style.boxShadow;
        const originalBorder = receiptElement.style.border;
        receiptElement.style.boxShadow = 'none';
        receiptElement.style.border = 'none';
        
        // 5. Use the modern doc.html method for high-quality, scaled rendering
        doc.html(receiptElement, {
            callback: function (doc) {
                // 6. Save the file
                const filename = `Receipt_${receiptData.company.receiptId}_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(filename);
                
                // 7. Restore original styles and button state
                receiptElement.style.boxShadow = originalBoxShadow;
                receiptElement.style.border = originalBorder;
                downloadBtn.innerHTML = originalText;
                downloadBtn.disabled = false;
                
                // Re-render to ensure the visual state in the browser is correct
                renderReceipt();
            },
            x: margin,
            y: margin,
            html2canvas: {
                scale: scaleFactor,
                windowWidth: receiptWidth,
                scrollY: 0,
                scrollX: 0,
            }
        });
    }

    // --- Initialization ---

    document.addEventListener('DOMContentLoaded', () => {
        renderReceipt();
    });

</script>

</body>
</html>
